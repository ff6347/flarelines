# Journal: 2026-02-06

## Session Summary

Investigated and fixed a critical data loss bug reported after TestFlight 1.1.0 update. Users were losing all their journal entries when updating the app.

## Root Cause Analysis

### The Problem
After updating to 1.1.0 via TestFlight, users lost all their journal data.

### Investigation Process
Used systematic debugging to trace the issue:

1. **Examined `Persistence.swift`** - Found `deleteStoreIfIncompatible()` function (lines 64-89) that was designed for "pre-release, no user data"
2. **Traced git history** - Found the Core Data model was renamed from `wolfsbit` to `flarelines` in commit `5889d6a`
3. **Connected the dots:**
   - Old app (1.0.x): Used `wolfsbit.xcdatamodeld`, stored data with wolfsbit metadata
   - New app (1.1.0): Uses `flarelines.xcdatamodeld`, looks for flarelines metadata
   - `deleteStoreIfIncompatible()` detected metadata mismatch â†’ deleted all user data

### Root Cause
The `deleteStoreIfIncompatible()` function treated the model rename as a schema incompatibility and silently deleted all user data. The comment said "pre-release, no user data" but the app now has real users.

## Fix Implemented

### Changes to `Persistence.swift`
1. **Removed destructive code:**
   - `deleteStoreIfIncompatible()` function
   - `defaultStoreURL()` helper
   - `deleteStoreFiles(at:)` helper

2. **Added lightweight migration:**
   ```swift
   let description = container.persistentStoreDescriptions.first
   description?.shouldMigrateStoreAutomatically = true
   description?.shouldInferMappingModelAutomatically = true
   ```

3. **Updated ABOUTME comments** to reflect new behavior (crash on failure instead of delete)

### Safety Philosophy
- **Before:** Silent data deletion on any incompatibility
- **After:** Crash to preserve data for potential recovery

The app will now crash if migration fails, but the SQLite file remains intact. This is intentional - data preservation over silent loss.

## Technical Insights

### Core Data Model Renames Are Dangerous
Renaming `.xcdatamodeld` changes the model's identity. Existing stores have metadata referencing the old model name, which Core Data interprets as incompatible.

### Lightweight Migration Handles Most Changes
- Adding optional attributes
- Adding entities
- Making attributes optional
- Simple renames with mapping

For complex migrations, versioned models with explicit mapping are needed.

## Files Changed

- `flarelines/Persistence.swift` - Removed ~50 lines of destructive code, added migration config
- `docs/plans/2026-02-04-safe-persistence.md` - Implementation plan (created)

## Branch Status

- Branch: `fix/data-loss`
- PR: https://github.com/ff6347/flarelines/pull/22
- All tests passing
- Ready for review and merge

## Lessons Learned

1. **"Pre-release" code survives into production** - Remove destructive development shortcuts before releasing
2. **Silent failures are worse than crashes** - Users can recover from crashes; they can't recover deleted data
3. **Model renames need migration planning** - Core Data tracks model identity by name
4. **The comment was a warning** - "Handles incompatible schema by wiping store (pre-release, no user data)" should have been removed when users arrived

## Next Steps

- Merge PR #22
- Release hotfix via TestFlight
- Consider adding telemetry for migration failures (with user consent)
- Unfortunately, lost data cannot be recovered for affected users
